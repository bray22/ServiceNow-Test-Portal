<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ClientSrc\js\router.js - TheHub Client Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="..\..\ClientSrc\res\img\logo-full-115.png" title="TheHub Client Documentation"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/collection.AlertCollection.html">collection.AlertCollection</a></li>
                                <li><a href="../classes/collection.BroadcastCollection.html">collection.BroadcastCollection</a></li>
                                <li><a href="../classes/collection.Collection.html">collection.Collection</a></li>
                                <li><a href="../classes/collection.DesktopCollection.html">collection.DesktopCollection</a></li>
                                <li><a href="../classes/collection.LayoutCollection.html">collection.LayoutCollection</a></li>
                                <li><a href="../classes/collection.NewsArticleCollection.html">collection.NewsArticleCollection</a></li>
                                <li><a href="../classes/collection.NewsCollection.html">collection.NewsCollection</a></li>
                                <li><a href="../classes/collection.ServiceCollection.html">collection.ServiceCollection</a></li>
                                <li><a href="../classes/collection.SizeCollection.html">collection.SizeCollection</a></li>
                                <li><a href="../classes/collection.WidgetCollection.html">collection.WidgetCollection</a></li>
                                <li><a href="../classes/model.AlertModel.html">model.AlertModel</a></li>
                                <li><a href="../classes/model.BroadcastModel.html">model.BroadcastModel</a></li>
                                <li><a href="../classes/model.DesktopModel.html">model.DesktopModel</a></li>
                                <li><a href="../classes/model.HeartbeatModel.html">model.HeartbeatModel</a></li>
                                <li><a href="../classes/model.Model.html">model.Model</a></li>
                                <li><a href="../classes/model.NewsArticleModel.html">model.NewsArticleModel</a></li>
                                <li><a href="../classes/model.NewsChannelModel.html">model.NewsChannelModel</a></li>
                                <li><a href="../classes/model.SizeModel.html">model.SizeModel</a></li>
                                <li><a href="../classes/model.UserModel.html">model.UserModel</a></li>
                                <li><a href="../classes/model.WidgetLayoutModel.html">model.WidgetLayoutModel</a></li>
                                <li><a href="../classes/model.WidgetModel.html">model.WidgetModel</a></li>
                                <li><a href="../classes/Tween.html">Tween</a></li>
                                <li><a href="../classes/view.AlertMenuView.html">view.AlertMenuView</a></li>
                                <li><a href="../classes/view.BalloonView.html">view.BalloonView</a></li>
                                <li><a href="../classes/view.ConfirmationView.html">view.ConfirmationView</a></li>
                                <li><a href="../classes/view.DesktopMenuView.html">view.DesktopMenuView</a></li>
                                <li><a href="../classes/view.DesktopOptionsView.html">view.DesktopOptionsView</a></li>
                                <li><a href="../classes/view.DesktopView.html">view.DesktopView</a></li>
                                <li><a href="../classes/view.DevMenuView.html">view.DevMenuView</a></li>
                                <li><a href="../classes/view.ExpirationView.html">view.ExpirationView</a></li>
                                <li><a href="../classes/view.HtmlModalView.html">view.HtmlModalView</a></li>
                                <li><a href="../classes/view.HubHelpView.html">view.HubHelpView</a></li>
                                <li><a href="../classes/view.HubView.html">view.HubView</a></li>
                                <li><a href="../classes/view.IframeAppmodeView.html">view.IframeAppmodeView</a></li>
                                <li><a href="../classes/view.IframeModalView.html">view.IframeModalView</a></li>
                                <li><a href="../classes/view.ModalView.html">view.ModalView</a></li>
                                <li><a href="../classes/view.NewsChannelList.html">view.NewsChannelList</a></li>
                                <li><a href="../classes/view.NewsView.html">view.NewsView</a></li>
                                <li><a href="../classes/view.Router.html">view.Router</a></li>
                                <li><a href="../classes/view.SearchResultsView.html">view.SearchResultsView</a></li>
                                <li><a href="../classes/view.ToastView.html">view.ToastView</a></li>
                                <li><a href="../classes/view.View.html">view.View</a></li>
                                <li><a href="../classes/view.WalkthroughView.html">view.WalkthroughView</a></li>
                                <li><a href="../classes/view.WidgetAppmodeView.html">view.WidgetAppmodeView</a></li>
                                <li><a href="../classes/view.WidgetView.html">view.WidgetView</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Ajax.html">Ajax</a></li>
                                <li><a href="../modules/AnimHelpers.html">AnimHelpers</a></li>
                                <li><a href="../modules/App.html">App</a></li>
                                <li><a href="../modules/ConfirmationView.html">ConfirmationView</a></li>
                                <li><a href="../modules/Expiration.html">Expiration</a></li>
                                <li><a href="../modules/HeartBeat.html">HeartBeat</a></li>
                                <li><a href="../modules/HeatBeat.html">HeatBeat</a></li>
                                <li><a href="../modules/HtmlModalView.html">HtmlModalView</a></li>
                                <li><a href="../modules/IframeAppmodeView.html">IframeAppmodeView</a></li>
                                <li><a href="../modules/IframeModalView.html">IframeModalView</a></li>
                                <li><a href="../modules/Messaging.html">Messaging</a></li>
                                <li><a href="../modules/Metrics.html">Metrics</a></li>
                                <li><a href="../modules/ToastView.html">ToastView</a></li>
                                <li><a href="../modules/Util.html">Util</a></li>
                                <li><a href="../modules/WidgetAppmodeView.html">WidgetAppmodeView</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ClientSrc\js\router.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
* router.js
*/

define([
    &quot;require&quot;, 
    &quot;backbone&quot;, 
    &quot;i18n!nls/Hub&quot;, 
    &quot;jquery&quot;,
    &quot;underscore&quot;,
    &quot;view/ExpirationView&quot;, 
    &quot;util/Ajax&quot;,
    &quot;view/View&quot;,
    &quot;view/HubView&quot;,
    &quot;util/Util&quot;,
    &quot;util/AnimHelpers&quot;], 
    function (require, 
        Backbone, 
        Strings, 
        $,
        _,
        ExpirationView, 
        Ajax, 
        View, 
        HubView, 
        Util, 
        AnimHelpers) {

    &quot;use strict&quot;;

    /**
    * The router, or &quot;App&quot; is the heart of the entire application, it handles the hash-navigation,
    * it composes the HubView, HubModel, UserModel, WidgetCollection, ServiceCollection
    * Through the App, a developer should be able to get to any model or view within the entire application
    *
    * You can get the app at any time using: &quot;require(&#x27;app&#x27;)&quot;
    * eg: require(&quot;app&quot;).WidgetCollection.where({Name: &quot;HubTV&quot;});
    * eg: require(&quot;app&quot;).HubModel.get(&quot;Debug&quot;);
    * eg: require(&quot;app&quot;).HubView.getActiveDesktopModel().get(&quot;WidgetCollection&quot;)
    * eg: require(&quot;app&quot;).UserModel.get(&quot;BadgeNumber&quot;)
    * eg: require(&quot;app&quot;).HubView.getActiveDesktopModel().trigger(&quot;save&quot;);
    *
    * @class Router
    * @extends Backbone.Router
    * @public
    * @constructor
    * @module App
    */
    var _router = Backbone.Router.extend({

        /**
        * defines all hash-navigations, and their respective methods to call when triggered
        *
        * @property routes
        * @type Object
        * @private
        */
        routes: {
            home: &quot;navToDesktop&quot;,
            fatalerror: &quot;navToFatal&quot;,
            loading: &quot;navToLoading&quot;,
            invalid: &quot;navToInvalid&quot;,
            maintenance: &quot;navToMaintenance&quot;,
            &quot;!&quot;: &quot;devError&quot;
        },

        /**
        * defines a list of all possible body-classes
        *
        * @property bodyClass
        * @type String
        * @private
        */
        bodyClass: [
            &quot;hub-ready&quot;,
            &quot;initial-load&quot;,
            &quot;invalid-browser&quot;, 
            &quot;fatal-error&quot;,
            &quot;maintenance&quot;
        ].join(&quot; &quot;),

        // ==========================================================================================================
        // ===========================================LOAD PRECEDURES================================================
        // ==========================================================================================================

        /**
        * beginning of start-up procedures
        *   - first localize any string tokens in the critical render, 
        *   - check for a valid browser before moving on
        *
        * @method _startup
        * @private
        */
        _loaded: false,
        _startup: function (cb) {
            this._localizeDom(View.prototype.localize);

            _router._loaded = true;

            if (Util.IsValidBrowser()) {
                this._loadStartup(Util.ParseQueryString(location.href), cb);
            } else {
                _router.navigate(&quot;invalid&quot;, {trigger: true});
            }
        },

        /**
        * replace string tokens within critical-render elements,
        * warning: browser reflow nightmare.
        *
        * @method _localizeDom
        * @private
        */
        _localizeDom: function (localize) {
            $(&quot;#fatalerror&quot;).html(localize.call(null, $(&quot;#fatalerror&quot;).html(), Strings));
            $(&quot;#desktop&quot;).html(localize.call(null, $(&quot;#desktop&quot;).html(), Strings));
            $(&quot;#invalid&quot;).html(localize.call(null, $(&quot;#invalid&quot;).html(), Strings));
            $(&quot;#maintenance&quot;).html(localize.call(null, $(&quot;#maintenance&quot;).html(), Strings));
        },

        /**
        * retrieve hub/user models - begin application contruction
        *
        * @param {Object} params - query string parameters
        * @param {Function} cb - on complete callback
        *
        * @method _loadStartup
        * @private
        */
        _loadStartup: function (params, cb) {
            this._initSession(params, $.proxy(function (token, userId) {
                this._loadAppModels(token, userId, params, cb);
            }, this));
        },

        /**
        * go to an SSO-outsystems page, to init the OS-session
        *
        * @param {Object} params - url parameters, possibly with EmployeeID acting as a backend override
        * @param {Function} cb - callback when complete
        *
        * @method _initSession
        * @private
        */
        _initSession: function (params, cb) {
            require([&quot;util/Environment&quot;], $.proxy(function (Environment) {

                // no environment url?
                if (!Environment) {
                    var href = location.href;
                    // did the user skip the server logic? (where we get the environment cookie)
                    if (href.indexOf(&quot;.html&quot;)) {
                        var query = href.indexOf(&quot;?&quot;) !== -1 ? href.substr(href.indexOf(&quot;?&quot;), href.length) : &quot;&quot;;
                        location.href = location.origin + query;
                    } else {
                        // dead-end :(
                        _router.navigate(&quot;fatalerror&quot;, {trigger: true});
                    }
                    return;
                }

                // if we don&#x27;t get a message within 10 seconds - display a friendly message
                var slowTimeout = setTimeout(function () {
                    $(&quot;#loading-slow-message&quot;).text(Strings.SlowLoadingMessage).animate({opacity: 1}, {
                        duration: 500
                    });
                }, 10000);

                // if we don&#x27;t get a message within 30 seconds - consider it a timeout failure
                var timeout = setTimeout($.proxy(function () {
                    $(window).off(&quot;message&quot;).off(&quot;onmessage&quot;);

                    console.error(&quot;SSO Authentication timeout.&quot;);

                    this.navigate(&quot;fatalerror&quot;, {trigger: true});
                }, this), 30000);

                // listen for messages coming from our SSO/Session iframe, with a token and userId
                $(window).on(&quot;message onmessage&quot;, $.proxy(function (e) {
                    var data;

                    try {
                        data = JSON.parse(e.originalEvent.data);
                    } catch (e) {
                        data = undefined;
                    } finally {
                        if (data &amp;&amp; data.event &amp;&amp; data.event === &quot;auth.hubtoken&quot;) {
                            $(window).off(e);

                            clearTimeout(timeout);
                            clearTimeout(slowTimeout);

                            if (data.token) {
                                cb(data.token, data.userId);
                            } else {
                                console.error(&quot;Session failed to initialize, message: %o&quot;, data);
                                this.navigate(&quot;fatalerror&quot;, {trigger: true});
                            }
                        } else if (data &amp;&amp; data.event &amp;&amp; data.event === &quot;login.redirect&quot;) {
                            $(window).off(e);
                            window.location = Environment + &quot;/ClientSession/LoginInit.aspx?target=&quot; + btoa(window.location.href);
                        }
                    }
                }, this));

                // add the iframe to the DOM, and begin the process
                var $sessionFrame = $(&quot;&lt;iframe&gt;&lt;/iframe&gt;&quot;, {
                    id: &quot;session-init&quot;,
                    src: Environment + &quot;/ClientSession/SsoToken.aspx&quot;
                }).appendTo(&quot;body&quot;);

                // refresh said iframe every hour, to ensure our cookies stay tasty
                setInterval($.proxy(function () {
                    this.attr(&quot;src&quot;, this.attr(&quot;src&quot;));
                }, $sessionFrame), 3600000);

            }, this));
        },

        /**
        * called after the outsystems session has been initialized
        * load the Hub/User models
        *
        * @param {String} token
        * @param {Number} userId
        * @param {Object} params - url arguments
        * @param {Function} onComplete
        *
        * @method _loadAppModels
        * @private
        */
        _loadAppModels: function (token, userId, params, onComplete) {
            Ajax.GetStartUp(token, userId, function (HubModel, UserModel) {
                
                this._loaded = true;

                if (HubModel &amp;&amp; HubModel.isValid() &amp;&amp; UserModel &amp;&amp; UserModel.isValid()) {
                    
                    this.HubModel = HubModel;

                    this.UserModel = UserModel;

                    _router.Metrics.UserLogin({
                        isNew: UserModel.get(&quot;IsFirstTimeUser&quot;)
                    });

                    if (HubModel.get(&quot;IsMaintenanceBreak&quot;)) {
                        this.navigate(&quot;maintenance&quot;, {trigger: true, replace: true});
                        return;
                    }

                    if (params.debug !== undefined) {
                        HubModel.set(&quot;Debug&quot;, Util.ParseBool(params.debug));
                    }

                    if (params.newuser !== undefined) {
                        UserModel.set(&quot;IsFirstTimeUser&quot;, Util.ParseBool(params.newuser));
                    }

                    if (HubModel.get(&quot;Debug&quot;)) {
                        console.info(&quot;Debug Mode Enabled&quot;);
                    }

                    this.HubView = new HubView({
                        model: {
                            HubModel: HubModel,
                            UserModel: UserModel
                        },
                        el: $(&quot;#desktop&quot;),
                        query: params
                    });

                    this._loadCollections(Ajax, UserModel);

                    this.HeartBeat.Start();
                    
                    this.Expiration.Start();

                    onComplete();

                } else {

                    this.navigate(&quot;fatalerror&quot;, { trigger: true });

                }

            }, this);
        },

        /**
        * load widget/service collections,
        * not needed for the main start-up process, but need to get this going as soon as possible,
        * widgetCollection is the largest/longest request we have
        *
        * @param {Object} Ajax
        * @param {UserModel} UserModel
        *
        * @method _loadCollections
        * @private
        */
        _loadCollections: function (Ajax, UserModel) {
            Ajax.GetContentLibraryWidgets(function (WidgetCollection) {
                if (WidgetCollection) {
                    this.WidgetCollection = WidgetCollection;
                    this.HubView.trigger(&quot;widget-load&quot;, WidgetCollection);
                } else if (this.HubModel.get(&quot;Debug&quot;)) {
                    console.error(&quot;Invalid WidgetCollection&quot;);
                }
            }, this);

            Ajax.GetServices(function (ServiceCollection) {
                if (ServiceCollection) {
                    this.ServiceCollection = ServiceCollection;
                } else if (this.HubModel.get(&quot;Debug&quot;)) {
                    console.error(&quot;Invalid ServiceCollection&quot;);
                }
            }, this);
        },

        // ==========================================================================================================
        // ===========================================NAVIGATIONS====================================================
        // ==========================================================================================================

        /**
        * go to the last-used desktop
        *
        * @method navToDesktop
        * @private
        */
        navToDesktop: function () {
            if (this._loaded === false) {
                this._startup(function () {
                    AnimHelpers.LoadingPageOut(function () {
                        $(&quot;body&quot;).removeClass(_router.bodyClass).addClass(&quot;hub-ready&quot;);
                        _router.HubView.trigger(&quot;load-complete&quot;);
                    });
                });
            } else {
                // TODO... already loaded, toggle current page
            }
        },

        /**
        * go to the fatal-error screen
        * note: this will check if we attempted to load yet (if the user refreshed on the fatalerror hash)
        *       if so, re-navigate to &quot;home&quot; and try again.
        *
        * @method navToFatal
        * @private
        */
        navToFatal: function () {
            if (this._loaded === false) {
                _router.navigate(&quot;home&quot;, {trigger: true, replace: true});
            } else {
                _router.HeartBeat.Stop();

                $(&quot;.hub-page&quot;).hide();

                $(&quot;.hub-page[data-page=&#x27;fatal&#x27;]&quot;).show();

                $(&quot;body&quot;).removeClass(_router.bodyClass).addClass(&quot;fatal-error&quot;);
            }
        },

        /**
        * for testing/dev purposes only - brings the initial-loading screen up
        *
        * @method navToLoading
        * @private
        */
        navToLoading: function () {
            $(&quot;.hub-page&quot;).hide();

            $(&quot;.hub-page[data-page=&#x27;loading&#x27;]&quot;).show();

            $(&quot;body&quot;).removeClass(_router.bodyClass).addClass(&quot;initial-load&quot;);
        },

        /**
        * for testing/dev purposes only - brings up the invalid-browser screen
        *
        * @method navToInvalid
        * @private
        */
        navToInvalid: function () {
            if (this._loaded === false) {
                _router.navigate(&quot;home&quot;, {trigger: true, replace: true});
            } else {
                _router.HeartBeat.Stop();

                $(&quot;.hub-page&quot;).hide();

                $(&quot;.hub-page[data-page=&#x27;invalid&#x27;]&quot;).show();

                $(&quot;body&quot;).removeClass(_router.bodyClass).addClass(&quot;invalid-browser&quot;);
            }
        },

        /**
        * when the site property flag &quot;IsMaintenanceBreak&quot; is true, or becomes true through the HeartBeat, this 
        * navigation will be triggered, landing the user on a &quot;come back later&quot; page
        *
        * @method navToMaintenance
        * @private
        */
        navToMaintenance: function () {
            if (this._loaded === false) {
                _router.navigate(&quot;home&quot;, {trigger: true, replace: true});
            } else {
                _router.HeartBeat.Stop();

                $(&quot;.hub-page&quot;).hide();

                $(&quot;.hub-page[data-page=&#x27;maintenance&#x27;]&quot;).show();

                $(&quot;body&quot;).removeClass(_router.bodyClass).addClass(&quot;maintenance&quot;);
            }
        },

        /**
        * stops silly developers from doing href=&quot;#!&quot; - which is incompatible here, and is bad-practice
        * if you are reading this, try doing href=&#x27;javascript:;&#x27; instead.
        *
        * @method devError
        * @private
        */
        devError: function () {
            if (_router.HubModel.get(&quot;Debug&quot;)) {
                $(&quot;body&quot;).html(&quot;&lt;h2&gt;Hey sloppy developer, you just triggered a &#x27;#!&#x27; hash navigation - ya know thats bad practice now-a-days...&lt;/h2&gt;&quot;);
            }
        },


        // ==========================================================================================================
        // ===========================================APPLICATION METHODS============================================
        // ==========================================================================================================


        /**
        * sub-module for controlling the application&#x27;s heartbeat
        * The heartbeat provides updates for client and server
        * Alerts, News, maintenance flagging, etc...
        *
        * @submodule HeatBeat
        * @public
        */
        HeartBeat: {

            /**
            * determine if the TheHub is on maintence break
            *
            * @param {HeartbeatModel} HeartbeatModel
            * @return {boolean} returns true if we don&#x27;t need to process any more heartbeat actions
            *
            * @method _processMaintenance
            * @submodule HeartBeat
            * @private
            */
            _processMaintenance: function (HeartbeatModel) {
                var stopProcess = false;

                if (HeartbeatModel.get(&quot;IsMaintenanceBreak&quot;)) {
                    require([&quot;view/ConfirmationView&quot;], function (ConfirmationView) {
                        var options = {};

                        options[Strings.MaintenanceKeepWorking] = function () {};

                        options[Strings.MaintenanceTakeABreak] = function () {
                            _router.navigate(&quot;maintenance&quot;, {trigger: true, replace: false});
                            _router.HeartBeat.Stop();
                        };

                        new ConfirmationView({
                            title: Strings.MaintenanceTitle,
                            message: Strings.MaintenanceMessage,
                            options: options
                        });
                    });

                    stopProcess = true;
                }

                return stopProcess;
            },

            /**
            * process new alerts
            *
            * @param {HeartbeatModel} HeartbeatModel
            *
            * @method _processAlerts
            * @submodule HeartBeat
            * @private
            */
            _processAlerts: function (HeartbeatModel) {
                var userAlerts = _router.UserModel.get(&quot;AlertCollection&quot;);

                HeartbeatModel.get(&quot;Alerts&quot;).each(function (alertModel, index, collection) {
                    var existing = userAlerts.where({AlertId: alertModel.get(&quot;AlertId&quot;)});
                    if (existing.length === 0) {
                        userAlerts.add(alertModel);
                    }
                });
            },

            /**
            * process new news articles
            *
            * @param {HeartbeatModel} HeartbeatModel
            *
            * @method _processNews
            * @submodule HeartBeat
            * @private
            */
            _processNews: function (HeartbeatModel) {
                var userNews = _router.HubView.NewsView.model;
                HeartbeatModel.get(&quot;News&quot;).each(function (hbChannel) {
                    var userChannel = userNews.where({ChannelId: hbChannel.get(&quot;ChannelId&quot;)});
                    if (userChannel.length) {
                        hbChannel.get(&quot;ArticleCollection&quot;).each(function (hbArticle) {
                            var article = userChannel[0].get(&quot;ArticleCollection&quot;).where({ArticleId: hbArticle.get(&quot;ArticleId&quot;)});

                            if (!article.length) {
                                userChannel[0].get(&quot;ArticleCollection&quot;).add(hbArticle);
                            }
                        });
                    }
                });
            },

            /**
            * if a user sits on the hub with a broadcast message visible, and waits long enough for
            * a heartbeat to come back with the same messages, this array storing their ID&#x27;s prevents duplicate
            * messages from being seen
            *
            * @property seenBroadcasts
            * @type Array
            * @private
            */
            seenBroadcasts: [],

            /**
            * process new broadcast messages
            *
            * @param {HeartbeatModel} HeartbeatModel
            *
            * @method _processBroadcasts
            * @submodule HeartBeat
            * @private
            */
            _processBroadcasts: function (HeartbeatModel) {
                var messages = HeartbeatModel.get(&quot;Broadcasts&quot;);

                if (messages.length) {
                    require([&quot;view/ConfirmationView&quot;], function (ConfirmationView) {
                        var message = [],
                            options = {},
                            dismissIdList = [];

                        HeartbeatModel.get(&quot;Broadcasts&quot;).each(function (msg) {
                            if (_router.HeartBeat.seenBroadcasts.indexOf(msg.get(&quot;Id&quot;)) === -1) {
                                message.push(View.prototype.template(&quot;BroadcastMessage&quot;, msg.attributes));
                                dismissIdList.push(msg.get(&quot;Id&quot;));
                                _router.HeartBeat.seenBroadcasts.push(msg.get(&quot;Id&quot;));
                            }
                        });

                        if (message.length) {
                            options[Strings.BroadcastMessagingConfirm] = function () {
                                Ajax.DismissBroadcastMessages(dismissIdList, function (success) {
                                    if (_router.HubModel.get(&quot;Debug&quot;)) {
                                        console.info(&quot;%s dismissed broadcast messages&quot;, success ? &quot;Successfully&quot; : &quot;Failed to&quot;);
                                    }
                                });
                            };

                            new ConfirmationView({
                                title: Strings.BroadcastMessagingTitle,
                                message: message.join(&quot;&lt;br/&gt;&quot;),
                                options: options,
                                hideCloseIcon: true
                            });
                        }
                    });
                }
            },

            /**
            * internally called to begin, and process the heartbeat,
            * if there is a maintenaince - does not process alerts/news
            *
            * @method process
            * @submodule HeartBeat
            * @private
            */
            process: function () {
                var postData = {
                    UserId: _router.UserModel.get(&quot;UserId&quot;),
                    AlertIdList: _router.UserModel.get(&quot;AlertCollection&quot;).getIdList(),
                    ArticleIdList: _router.HubView.NewsView.model.getIdList()
                };

                Ajax.HeartBeat(postData, function (HeartbeatModel) {
                    var debug = _router.HubModel.get(&quot;Debug&quot;);

                    if (debug) {
                        console.log(&quot;heartbeat update: %o&quot;, HeartbeatModel);
                    }

                    if (!HeartbeatModel) {
                        if (debug) {
                            console.warn(&quot;Invalid HeartbeatModel&quot;);
                        }
                        return;
                    }

                    if (_router.HeartBeat._processMaintenance(HeartbeatModel)) {
                        return;
                    }

                    _router.HeartBeat._processAlerts(HeartbeatModel);

                    _router.HeartBeat._processNews(HeartbeatModel);

                    _router.HeartBeat._processBroadcasts(HeartbeatModel);
                });
            },

            /**
            * the setInterval handle property
            *
            * @property timer
            * @type Integer
            * @submodule HeartBeat
            * @private
            */
            timer: null,

            /**
            * start the heartbeat
            *
            * @method Start
            * @submodule HeartBeat
            * @public
            */
            Start: function () {
                if (!_router.HeartBeat.timer) {
                    _router.HeartBeat.timer = setInterval(_router.HeartBeat.process, _router.HubModel.get(&quot;HeartbeatInterval&quot;));
                }
            },

            /**
            * stop/pause the heartbeat
            *
            * @method Stop
            * @submodule HeartBeat
            * @public
            */
            Stop: function () {
                if (_router.HeartBeat.timer) {
                    clearInterval(_router.HeartBeat.timer);
                    _router.HeartBeat.timer = null;
                }
            }
        },

        /**
        * sub-module controlling client-expiration
        *
        * @submodule Expiration
        * @public
        */
        Expiration: {

            /**
            * the setTimout handle property
            *
            * @property timer
            * @type Integer
            * @submodule Expiration
            * @private
            */
            timer: null,

            /**
            * start the expiration timer
            *
            * @method Start
            * @submodule Expiration
            * @public
            */
            Start: function () {
                if (!_router.Expiration.timer) {
                    setTimeout(_router.Expiration.Execute, _router.HubModel.get(&quot;ExpirationTimeout&quot;));
                }
            },

            /**
            * stop the expiration timer
            *
            * @method Stop
            * @submodule Expiration
            * @public
            */
            Stop: function () {
                if (_router.Expiration.timer) {
                    clearTimeout(_router.Expiration.timer);

                    _router.Expiration.timer = null;

                    _router.HeartBeat.Stop();
                    
                    require([&quot;util/Messaging&quot;], function (Messaging) {
                        Messaging.Stop();
                    });
                }
            },

            /**
            * reset the expiration timeout
            *
            * @method Reset
            * @submodule Expiration
            * @public
            */
            Reset: function () {
                if (_router.Expiration.timer) {
                    clearTimeout(_router.Expiration.timer);
                    _router.Expiration.timer = null;
                }
                _router.Expiration.Start();
            },

            /**
            * display the expiration message
            *
            * @method Execute
            * @submodule Expiration
            * @public
            */
            Execute: function () {
                _router.Expiration.timer = null;
                if (!_router.Expiration.ExpirationView) {
                    _router.Expiration.ExpirationView = new ExpirationView();
                }
            }
        },

        /**
        * sub-module for logging user metrics
        *
        * @submodule Metrics
        * @public
        */
        Metrics: {

            /**
            * user logged in
            *
            * @method UserLogin
            * @submodule Metrics
            * @public
            */
            UserLogin: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;User_Login&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user added a widget
            *
            * @method WidgetAddToDesktop
            * @submodule Metrics
            * @public
            */
            WidgetAddToDesktop: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Widget_AddToDesktop&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user removed a widget
            *
            * @method WidgetRemove
            * @submodule Metrics
            * @public
            */
            WidgetRemove: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Widget_Remove&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user resized a widget
            *
            * @method WidgetResized
            * @submodule Metrics
            * @public
            */
            WidgetResized: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Widget_Resize&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user laucned widget appmode
            *
            * @method WidgetAppmodeViewed
            * @submodule Metrics
            * @public
            */
            WidgetAppmodeViewed: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Widget_AppMode&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user focused on the search bar
            *
            * @method SearchBarClicked
            * @submodule Metrics
            * @public
            */
            SearchBarClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_Search&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user launched a service
            *
            * @method ServiceClicked
            * @submodule Metrics
            * @public
            */
            ServiceClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_Service&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user viewed an alert
            *
            * @method NotificationIconClicked
            * @submodule Metrics
            * @public
            */
            NotificationIconClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_ViewAlerts&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user clicked on manage alerts
            *
            * @method ManageAlertsClicked
            * @submodule Metrics
            * @public
            */
            ManageAlertsClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_ManageAlerts&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user viewed all alerts
            *
            * @method ViewAllAlertsClicked
            * @submodule Metrics
            * @public
            */
            ViewAllAlertsClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_ViewAllAlerts&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user dismissed an alert
            *
            * @method DismissAlertClicked
            * @submodule Metrics
            * @public
            */
            DismissAlertClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_DismissAlert&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user viewed all services
            *
            * @method ViewAllServicesClicked
            * @submodule Metrics
            * @public
            */
            ViewAllServicesClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_ViewAllServices&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user clicked on my info
            *
            * @method MyInfoClicked
            * @submodule Metrics
            * @public
            */
            MyInfoClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_MyInfo&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user opened the content library
            *
            * @method ContentLibraryClicked
            * @submodule Metrics
            * @public
            */
            ContentLibraryClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_ContentLibraryOpen&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user closed the content library
            *
            * @method ContentLibraryClosed
            * @submodule Metrics
            * @public
            */
            ContentLibraryClosed: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_ContentLibraryClose&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user clicked on the help menu
            *
            * @method HelpClicked
            * @submodule Metrics
            * @public
            */
            HelpClicked: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_Help&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * user searched the content library
            *
            * @method ContentLibrarySearch
            * @submodule Metrics
            * @public
            */
            ContentLibrarySearch: function (args) {
                Ajax.FireMetricEvent(_.extend({
                    actionType: &quot;Click_ContentLibrarySearch&quot;
                }, args), _router.Metrics._onComplete, _router);
            },

            /**
            * callback when any metric request comes back
            *
            * @method _onComplete
            * @submodule Metrics
            * @private
            */
            _onComplete: function () {
                // TODO: handle request callback
            }
        },

        /**
        * retrieve the plugin-icon stylesheet 
        * (I don&#x27;t like this... outsystems doesn&#x27;t make it easy)
        *
        * @method LoadPluginIcons
        * @public
        */
        _iconsLoaded: false,
        LoadPluginIcons: function () {
            if (!this._iconsLoaded) {
                Ajax.GetPluginStylesheet(function (stylesheet) {
                    if (stylesheet) {
                        $(&quot;&lt;style&gt;&lt;/style&gt;&quot;, {
                            id: &quot;plugin-icon&quot;,
                            type: &quot;text/css&quot;,
                            text: stylesheet
                        }).appendTo(&quot;head&quot;);

                        this.WidgetCollection.each(function (widgetModel) {
                            widgetModel.set(&quot;Icon&quot;, &quot;plugin&quot; + widgetModel.get(&quot;PluginId&quot;) + &quot;-icon&quot;);
                        });
                    } else if (_router.HubModel.get(&quot;Debug&quot;)) {
                        console.error(&quot;Router.LoadPluginIcons() - failed&quot;);
                    }
                }, this);

                this._iconsLoaded = true;
            }
        }
    });

    return _router = new _router();
});
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
